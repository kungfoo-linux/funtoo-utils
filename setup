#!/bin/python2

import subprocess

subprocess.call(["blkid"])
ROOT = raw_input('ROOT: /dev/')
BOOT = raw_input('BOOT: /dev/')
SWAP = raw_input('SWAP: /dev/')
BOOTLOADER = raw_input('Install bootloader to: /dev/')
USERNAME = raw_input('Username: ')
print 'Installing...'
DEST = '/mnt/dest'
subprocess.call(['install', '-d', DEST])
#subprocess.call(['umount', DEST + '/boot'])
#subprocess.call(['umount', DEST])
subprocess.call(['mount', '/dev/' + ROOT, DEST])
subprocess.call(['install', '-d', DEST + '/boot'])
subprocess.call(['mount', '/dev/' + BOOT, DEST + '/boot'])
subprocess.call(['rm', '-r', '-f', DEST + '/squashfs-root'])
subprocess.call(['unsquashfs', '-f', '-d', DEST, '/mnt/cdrom/image.squashfs'])
subprocess.call(['post_unpack', DEST])
fstab = open(DEST + "/etc/fstab", "w")
print >>fstab, """
# /etc/fstab: static file system information.
#
# noatime turns off atimes for increased performance (atimes normally aren't 
# needed); notail increases performance of ReiserFS (at the expense of storage 
# efficiency).  It's safe to drop the noatime options if you want and to 
# switch between notail / tail freely.
#
# The root filesystem should have a pass number of either 0 or 1.
# All other filesystems should have a pass number of 0 or greater than 1.
#
# See the manpage fstab(5) for more information.
#

# <fs>			<mountpoint>	<type>		<opts>		<dump/pass>

# NOTE: If your BOOT partition is ReiserFS, add the notail option to opts.
"""
print >>fstab, "/dev/" + BOOT + "		/boot		ext2		noauto,noatime	1 2"
print >>fstab, "/dev/" + ROOT + "		/		ext3		noatime		0 1"
print >>fstab, "/dev/" + SWAP + "		none		swap		sw		0 0"
print >>fstab, "/dev/cdrom		/mnt/cdrom	auto		noauto,ro	0 0"
print >>fstab, "/dev/fd0		/mnt/floppy	auto		noauto		0 0"
print >>fstab, ""
fstab.close()
repos_conf = open(DEST + '/etc/portage/repos.conf', 'w')
print >>repos_conf, '[DEFAULT]'
print >>repos_conf, 'main-repo = gentoo'
print >>repos_conf, ''
print >>repos_conf, '[gentoo]'
print >>repos_conf, 'location = /usr/portage'
print >>repos_conf, 'sync-type = git'
print >>repos_conf, 'sync-uri = git://github.com/matijaskala/ports-2013.git'
print >>repos_conf, 'auto-sync = yes'
print >>repos_conf, ''
repos_conf.close()
subprocess.call(['mount', '-B', '/proc', DEST + '/proc'])
subprocess.call(['touch', DEST + '/etc/resolv.conf'])
subprocess.call(['mount', '-B', '/etc/resolv.conf', DEST + '/etc/resolv.conf'])
subprocess.call(['chroot', DEST, 'git', 'clone', 'git://github.com/matijaskala/ports-2013.git', '/usr/portage'])
subprocess.call(['chroot', DEST, 'sh', '-c', "ACCEPT_KEYWORDS=\'~amd64\' emerge -q google-chrome"])
subprocess.call(['chroot', DEST, 'sh', '-c', "ACCEPT_KEYWORDS=\'~amd64\' emerge -q shadow"])
subprocess.call(['chroot', DEST, 'useradd', '-mp', '', '-G', 'audio,disk,users,video,wheel', USERNAME])
subprocess.call(['chroot', DEST, 'grub2-install', '/dev/' + BOOTLOADER])
subprocess.call(['chroot', DEST, 'grub2-mkconfig', '-o', '/boot/grub/grub.cfg'])
subprocess.call(['umount', DEST + '/etc/resolv.conf'])
subprocess.call(['umount', DEST + '/proc'])
